<!DOCTYPE html>
<html>
<head>
    <title>Conversation avec votre conseiller IAmonjob</title>
    <!-- Les styles restent identiques -->
    <style>
        /* Vos styles existants */
    </style>
</head>
<body>
    <h1>Conversation avec votre conseiller IAmonjob</h1>
    <center><img src="https://cbe-sud94.org/wp-content/uploads/2024/06/Caroussel-GPTs-min-1-300x180.jpg" alt="IAMONJOB" class="logo"> </center>
    
    <!-- Onglets de navigation -->
    <div class="tabs">
        <div class="tab active" data-tab="chat">Discussion</div>
        <div class="tab" data-tab="upload-cv">Analyse de CV</div>
        <div class="tab" data-tab="compare">Comparaison CV/Offre</div>
    </div>
    
    <!-- Les contenus d'onglets restent les mêmes -->
    
    <script>
        // Générer un identifiant de session unique
        function generateSessionId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Stockage de l'identifiant de session
        let sessionId = localStorage.getItem('iamonjob_session_id');
        if (!sessionId) {
            sessionId = generateSessionId();
            localStorage.setItem('iamonjob_session_id', sessionId);
        }
        
        // Définir un cookie de session
        document.cookie = `session_id=${sessionId}; path=/; max-age=86400`;
        
        // Le reste du code JavaScript avec les modifications pour maintenir l'état de la conversation
        
        // Fonction pour envoyer un message dans le chat
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (message) {
                // Afficher le message de l'utilisateur
                const chatContainer = document.getElementById('chat-container');
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'user-message';
                userMessageDiv.textContent = message;
                chatContainer.appendChild(userMessageDiv);
                
                // Vider l'input
                messageInput.value = '';
                
                // Faire défiler vers le bas
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Envoyer la requête au serveur
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(data => {
                    // Afficher la réponse de IAmonjob
                    const cyranoMessageDiv = document.createElement('div');
                    cyranoMessageDiv.className = 'cyrano-message';
                    cyranoMessageDiv.textContent = data.response;
                    chatContainer.appendChild(cyranoMessageDiv);
                    
                    // Faire défiler vers le bas à nouveau
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                })
                .catch(error => {
                    console.error('Erreur:', error);
                });
            }
        }
        
        // Gestion du téléchargement de documents
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Afficher un message de chargement
            document.getElementById('upload-status').textContent = 'Téléchargement en cours...';
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('upload-status').textContent = 'Document téléchargé avec succès!';
                
                // Afficher la réponse dans l'onglet d'analyse
                const resultContainer = document.getElementById('upload-result-container');
                const cyranoMessageDiv = document.createElement('div');
                cyranoMessageDiv.className = 'cyrano-message';
                cyranoMessageDiv.textContent = data.response;
                resultContainer.innerHTML = ''; // Vider les résultats précédents
                resultContainer.appendChild(cyranoMessageDiv);
                
                // Faire défiler vers le bas
                resultContainer.scrollTop = resultContainer.scrollHeight;
                
                // Ajouter également au chat principal
                const chatContainer = document.getElementById('chat-container');
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'user-message';
                userMessageDiv.textContent = 'J\'ai téléchargé un document pour analyse.';
                chatContainer.appendChild(userMessageDiv);
                
                const chatCyranoMessageDiv = document.createElement('div');
                chatCyranoMessageDiv.className = 'cyrano-message';
                chatCyranoMessageDiv.textContent = data.response;
                chatContainer.appendChild(chatCyranoMessageDiv);
                
                // Faire défiler vers le bas
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Basculer vers l'onglet chat pour continuer la conversation
                document.querySelector('.tab[data-tab="chat"]').click();
            })
            .catch(error => {
                document.getElementById('upload-status').textContent = 'Erreur lors du téléchargement: ' + error;
                console.error('Erreur:', error);
            });
        });
        
        // Gestion de la comparaison CV/Offre avec le même comportement
        document.getElementById('compare-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Vérifications et traitement similaires
            const cvFile = document.getElementById('cv-file').files[0];
            const offerFile = document.getElementById('offer-file').files[0];
            
            if (!cvFile || !offerFile) {
                document.getElementById('compare-status').textContent = 'Veuillez télécharger à la fois un CV et une offre d\'emploi.';
                return;
            }
            
            const formData = new FormData(this);
            
            document.getElementById('compare-status').textContent = 'Comparaison en cours...';
            document.getElementById('compare-spinner').style.display = 'block';
            
            fetch('/comparer', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('compare-spinner').style.display = 'none';
                document.getElementById('compare-status').textContent = 'Comparaison terminée!';
                
                // Afficher la réponse dans l'onglet de comparaison
                const resultContainer = document.getElementById('compare-result-container');
                const cyranoMessageDiv = document.createElement('div');
                cyranoMessageDiv.className = 'cyrano-message';
                cyranoMessageDiv.textContent = data.response;
                resultContainer.innerHTML = '';
                resultContainer.appendChild(cyranoMessageDiv);
                
                // Faire défiler vers le bas
                resultContainer.scrollTop = resultContainer.scrollHeight;
                
                // Ajouter également au chat principal
                const chatContainer = document.getElementById('chat-container');
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'user-message';
                userMessageDiv.textContent = 'J\'ai demandé une comparaison entre mon CV et une offre d\'emploi.';
                chatContainer.appendChild(userMessageDiv);
                
                const chatCyranoMessageDiv = document.createElement('div');
                chatCyranoMessageDiv.className = 'cyrano-message';
                chatCyranoMessageDiv.textContent = data.response;
                chatContainer.appendChild(chatCyranoMessageDiv);
                
                // Basculer vers l'onglet chat pour continuer la conversation
                document.querySelector('.tab[data-tab="chat"]').click();
            })
            .catch(error => {
                document.getElementById('compare-spinner').style.display = 'none';
                document.getElementById('compare-status').textContent = 'Erreur lors de la comparaison: ' + error;
                console.error('Erreur:', error);
            });
        });
        
        // Le reste du code JavaScript reste identique
    </script>
</body>
</html>
